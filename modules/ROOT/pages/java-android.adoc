
= Couchbase Lite Java (Android) framework
:idprefix:
:idseparator: -
:snippet: {examplesdir}/java-android/app/src/main/java/com/couchbase/code_snippets/Examples.java
:ziputils: {examplesdir}/java-android/app/src/main/java/com/couchbase/code_snippets/ZipUtils.java
:source-language: java
:version: 2.7.0
:packageNm: couchbase-lite-android
:blank-field: ____
:url-issues-java: https://github.com/couchbase/couchbase-lite-android/issues
:url-api-references: http://docs.couchbase.com/mobile/{version}/couchbase-lite-android
:page-aliases: java

include::_attributesLocal.adoc[]


== Getting Started

Create or open an existing Android Studio project and install Couchbase Lite using the following method.

Make the following additions to the module-level `build.gradle` file (typically in the *app* folder).


[{tabs}]
====
Community::
+
--
. Include the following in the `android {}` section:
+
[source,groovy]
----
include::partial$gsBuildGradleAndroid.adoc[tag=compileOptions]
----
. Include the following in the `dependencies{}` section:
+
[source,groovy]
----
include::partial$gsBuildGradleAndroid.adoc[tag=dependenciesCE]
----

--
Enterprise::
+
--
. Include the following in the `android {}` section:
+
[source,groovy]
----
include::partial$gsBuildGradleAndroid.adoc[tag=compileOptions]
----


. Include the following in the `dependencies{}` section:
+
[source,groovy]
----
include::partial$gsBuildGradleAndroid.adoc[tag=dependencies]
----
+
. Include the following in the `repositories {}` section:
+
[source,groovy]
----
include::partial$gsBuildGradleAndroid.adoc[tag=repositories]
----
--
====


=== Starter code

Open *MainActivity.java* in Android Studio and copy the following code in the `onCreate` method.
This snippet demonstrates how to run basic CRUD operations, a simple Query and running bi-directional replications with Sync Gateway.

[source]
----
include::{snippet}[tag=getting-started,indent=0]
----

Build and run.
You should see the document ID and property printed to the console.
The document was successfully persisted to the database.

xref:sync-gateway::getting-started.adoc#installation[Installing Sync Gateway ->]

== Supported Versions

The operating systems listed below refer to "Certified" versions of Android.
We do not test against, nor guarantee support for, uncertified Android versions such as versions built from source.

:msg_component: API 19 and 21
:msg_action:  Please plan to migrate your apps to use API versions greater than API 21
:msg_release: 2.6
include::_partials/deprecationNotice.adoc[]

[%autowidth.stretch]
|===
|Platform |Runtime architectures |Minimum API Level

|Android
|armeabi-v7a
|22

|Android
|arm64-v8a
|22

|Android
|x86
|22

|Android
|x86_64
|22
|===

== API References

{url-api-references}[Java SDK API References]

== Upgrading

=== Android Studio

The API changed in Couchbase Lite 2.0 and you will need to port any application that is using Couchbase Lite 1.x API to the latest Couchbase Lite API.
To update an Android project built with Couchbase Lite 1.x:

* Remove the existing Couchbase Lite dependency from the Android Studio project.
* Install the Couchbase Lite framework in your project (see the <<getting-started, Getting Started>> section).
At this point, there will be many compiler warnings.
Refer to the examples on this page to learn about the new API.
* Build & run your application.

=== Database Upgrade

Databases created using Couchbase Lite 1.2 or later can still be used with Couchbase Lite 2.x; but will be automatically updated to the  current 2.x version.
This feature is only available for the default storage type (i.e., not a ForestDB database).
Additionally, the automatic migration feature does not support encrypted databases, so if the 1.x database is encrypted you will first need to disable encryption using the Couchbase Lite 1.x API (see the xref:1.4@{source-language}.adoc#database-encryption[1.x Database Guide]).

==== Handling of Existing Conflicts

If there are existing conflicts in the 1.x database, the automatic upgrade process copies the default winning revision to the new database and does NOT copy any conflicting revisions.
This functionality is related to the way conflicts are now being handled in Couchbase Lite (see xref:{source-language}.adoc#handling-conflicts[Handling Conflicts]).
Optionally, existing conflicts in the 1.x database can be resolved with the xref:1.4@{source-language}.adoc#resolving-conflicts[1.x API] prior to the database being upgraded.

==== Handling of Existing Attachments

Attachments persisted in a 1.x database are copied to the new database.
NOTE: The relevant Couchbase Lite API is now called the `Blob` API not the `Attachments` API.

The functionally is identical but the internal schema for attachments has changed.
Blobs are stored anywhere in the document, just like other value types, whereas in 1.x they were stored under the `_attachments` field.
The automatic upgrade functionality *does not* update the internal schema for attachments, so they remain accessible under the `_attachments` field.
The following example shows how to retrieve an attachment that was created in a 1.x database with a 2.x API.
[source]
----
include::{snippet}[tag=1x-attachment,indent=0]
----

=== Replication Compatibility

The current replication protocol is not backwards compatible with the 1.x replication protocol.
Therefore, to use replication with Couchbase Lite 2.x, the target Sync Gateway instance must also be upgraded to 2.x.

Sync Gateway 2.x will continue to accept clients that connect through the 1.x protocol.
It will automatically use the 1.x replication protocol when a Couchbase Lite 1.x client connects through \http://localhost:4984/db and the 2.0 replication protocol when a Couchbase Lite 2.0 client connects through ws://localhost:4984/db.
This allows for a smoother transition to get all your user base onto a version of your application built with Couchbase Lite 2.x.

== Initializer

Your first step in using the API must be to call its initializer.
An exception is raised if any other API method is invoked before the  initializer.

[source]
----
include::{snippet}[tag=sdk-initializer,indent=0]
----

== Database

=== New Database

As the top-level entity in the API, new databases can be created using the `Database` class by passing in a name, configuration, or both.
The following example creates a database using the `Database(String name, DatabaseConfiguration config)` method.

[source]
----
include::{snippet}[tag=new-database,indent=0]
----

Just as before, the database will be created in a default location.
Alternatively, the `Database(string name, DatabaseConfiguration config)` initializer can be used to provide specific options in the {url-api-references}/com/couchbase/lite/DatabaseConfiguration.html[`DatabaseConfiguration`] object such as the database directory.

=== Database Encryption

.Enterprise Edition only
IMPORTANT: Database encryption is an https://www.couchbase.com/products/editions[Enterprise Edition] feature.

The Couchbase Lite 2.1 release includes the ability to encrypt Couchbase Lite databases.
This allows mobile applications to secure the data at rest, when it is being stored on the device.
The algorithm used to encrypt the database is 256-bit AES.

include::partial$database-encryption.adoc[]

=== Finding a Database File

When the application is running on the Android emulator, you can locate the application's data folder and access the database file by using the *adb* CLI tools.
For example, to list the different databases on the emulator, you can run the following commands.

[source,bash]
----
$ adb shell
$ su
$ cd /data/data/{APPLICATION_ID}/files
$ ls
----

The *adb pull* command can be used to pull a specific database to your host machine.

[source,bash]
----
$ adb root
$ adb pull /data/data/{APPLICATION_ID}/files/{DATABASE_NAME}.cblite2 .
----

=== CLI tool

`cblite` is a command-line tool for inspecting and querying Couchbase Lite 2.x databases.

You can download and build it from the couchbaselabs https://github.com/couchbaselabs/couchbase-mobile-tools/blob/master/README.cblite.md[GitHub repository].
Note that the `cblite` tool is not supported by the https://www.couchbase.com/support-policy[Couchbase Support Policy].

=== Logging

If you are using a Couchbase Lite release prior to 2.5 see <<Logging functionality prior to Release 2.5, Deprecated functionality>>

include::partial$logging.adoc[leveloffset=+2]

==== Logging functionality prior to Release 2.5

include::partial$logging-pre2.5.adoc[]

[source, {source-language}]

----
include::{snippet}[tags=logging,indent=0]
----

=== Loading a pre-built database

If your app needs to sync a lot of data initially, but that data is fairly static and won't change much, it can be a lot more efficient to bundle a database in your application and install it on the first launch.
Even if some of the content changes on the server after you create the app, the app's first pull replication will bring the database up to date.

To use a prebuilt database, you need to set up the database, build the database into your app bundle as a resource, and install the database during the initial launch.
After your app launches, it needs to check whether the database exists.
If the database does not exist, the application should copy it from the assets folder to the app's files directory.

[source]
----
include::{snippet}[tag=prebuilt-database,indent=0]
----

In the example below, the `ZipUtils.unzip` method copies the zipped pre-built database from the APK's *assets* directory to the *files* directory.
This method is provided below for reference as it isn't included in the Couchbase Lite library.

[source]
----
include::{ziputils}[tag=ziputils-unzip,indent=0]
----

== Document

In Couchbase Lite, a document's body takes the form of a JSON object -- a collection of key/value pairs where the values can be different types of data such as numbers, strings, arrays or even nested objects.
Every document is identified by a document ID, which can be automatically generated (as a UUID) or specified programmatically;
the only constraints are that it must be unique within the database, and it can't be changed.

=== Initializers

The following methods/initializers can be used:

* The `MutableDocument()` initializer can be used to create a new document where the document ID is randomly generated by the database.
* The `MutableDocument(withID: String)` initializer can be used to create a new document with a specific ID.
* The `database.getDocument(String id)` method can be used to get a document.
If it doesn't exist in the database, it will return `null`.
This method can be used to check if a document with a given ID already exists in the database.

The following code example creates a document and persists it to the database.

[source]
----
include::{snippet}[tag=initializer,indent=0]
----

=== Mutability

By default, when a document is read from the database it is immutable.
The `document.toMutable()` method should be used to create an instance of the document which can be updated.

[source]
----
include::{snippet}[tag=update-document,indent=0]
----

Changes to the document are persisted to the database when the `save` method is called.

=== Typed Accessors

The `Document` class now offers a set of {url-api-references}/com/couchbase/lite/Dictionary.html[`property accessors`] for various scalar types, including boolean, integers, floating-point and strings.
These accessors take care of converting to/from JSON encoding, and make sure you get the type you're expecting.

In addition, as a convenience we offer `Date` accessors.
Dates are a common data type, but JSON doesn't natively support them, so the convention is to store them as strings in ISO-8601 format.
The following example sets the date on the `createdAt` property and reads it back using the `document.getDate(String key)` accessor method.

[source]
----
include::{snippet}[tag=date-getter,indent=0]
----

If the property doesn't exist in the document it will return the default value for that getter method (0 for `getInt`, 0.0 for `getFloat` etc.).
To check whether a given property exists in the document, you should use the {url-api-references}/com/couchbase/lite/Document.html#contains-java.lang.String-[`Document.Contains(String key)`] method.

=== Batch operations

If you're making multiple changes to a database at once, it's faster to group them together.
The following example persists a few documents in batch.

[source]
----
include::{snippet}[tag=batch,indent=0]
----

At the *local* level this operation is still transactional: no other `Database` instances, including ones managed by the replicator can make changes during the execution of the block, and other instances will not see partial changes.
But Couchbase Mobile is a distributed system, and due to the way replication works, there's no guarantee that Sync Gateway or other devices will receive your changes all at once.

=== Document change events

It's also possible to register for document changes.
The following example registers for changes to the document with ID `user.john` and prints the `verified_account` property.

[source]
----
include::{snippet}[tag=document-listener,indent=0]
----

=== Document Expiration

include::partial$document-expiration.adoc[]

== Blobs

We've renamed "attachments" to "blobs".
The new behavior should be clearer too: a `Blob` is now a normal object that can appear in a document as a property value.
In other words, you just instantiate a `Blob` and set it as the value of a property, and then later you can get the property value, which will be a `Blob` object.
The following code example adds a blob to the document under the `avatar` property.

[source]
----
include::{snippet}[tag=blob,indent=0]
----

The `Blob` API lets you access the contents as in-memory data (a `Data` object) or as a `InputStream`.
It also supports an optional `type` property that by convention stores the MIME type of the contents.

In the example above, "image/jpeg" is the MIME type and "avatar" is the key which references that `Blob`.
That key can be used to retrieve the `Blob` object at a later time.

When a document is synchronized, the Couchbase Lite replicator will add an `_attachments` dictionary to the document's properties if it contains a blob.
A random access name will be generated for each `Blob` which is different to the "avatar" key that was used in the example above.
On the image below, the document now contains the `_attachments` dictionary when viewed in the Couchbase Server Admin Console.

image::attach_replicated.png[]

A blob also has properties such as `"digest"` (a SHA-1 digest of the data), `"length"` (the length in bytes), and optionally `"content_type"` (the MIME type).
The data is not stored in the document, but in a separate content-addressable store, indexed by the digest.

This `Blob` can be retrieved on the Sync Gateway REST API at \http://localhost:4984/justdoit/user.david/blob_1.
Notice that the blob identifier in the URL path is "blob_1" (not "avatar").

== Query

Database queries have changed significantly.
Instead of the map/reduce views used in 1.x, they're now based on expressions, of the form "return {blank-field} from documents where {blank-field}, ordered by {blank-field}", with semantics based on Couchbase's N1QL query language.

There are several parts to specifying a query:

SELECT:: Specifies the projection, which is the part of the document that is to be returned.
FROM:: Specifies the database to query the documents from.
JOIN:: Specifies the matching criteria in which to join multiple documents.
WHERE:: Specifies the query criteria that the result must satisfy.
GROUP BY:: Specifies the query criteria to group rows by.
ORDER BY:: Specifies the query criteria to sort the rows in the result.

=== SELECT statement

With the SELECT statement, you can query and manipulate JSON data.
With projections, you retrieve just the fields that you need and not the entire document.

A SelectResult represents a single return value of the query statement.
You can specify a comma separated list of `SelectResult` expressions in the select statement of your query.
For instance the following select statement queries for the document `_id` as well as the `type` and `name` properties of all documents in the database.
In the query result, we print the `_id` and `name` properties of each row using the property name getter method.

[source,json]
----
{
    "_id": "hotel123",
    "type": "hotel",
    "name": "Apple Droid"
}
----

[source]
----
include::{snippet}[tag=query-select-meta,indent=0]
----

The `SelectResult.all()` method can be used to query all the properties of a document.
In this case, the document in the result is embedded in a dictionary where the key is the database name.
The following snippet shows the same query using `SelectResult.all()` and the result in JSON.

[source]
----
include::{snippet}[tag=query-select-all,indent=0]
----

[source,json]
----
[
    {
        "travel-sample": {
            "callsign": "MILE-AIR",
            "country": "United States",
            "iata": "Q5",
            "icao": "MLA",
            "id": 10,
            "name": "40-Mile Air",
            "type": "airline"
        }
    },
    {
        "travel-sample": {
            "callsign": "TXW",
            "country": "United States",
            "iata": "TQ",
            "icao": "TXW",
            "id": 10123,
            "name": "Texas Wings",
            "type": "airline"
        }
    }
]
----

=== WHERE statement

Similar to SQL, you can use the where clause to filter the documents to be returned as part of the query.
The select statement takes in an `Expression`.
You can chain any number of Expressions in order to implement sophisticated filtering capabilities.

==== Comparison

The {url-api-references}/com/couchbase/lite/Expression.html[comparison operators] can be used in the WHERE statement to specify on which property to match documents.
In the example below, we use the `equalTo` operator to query documents where the `type` property equals "hotel".

[source,json]
----
{
    "_id": "hotel123",
    "type": "hotel",
    "name": "Apple Droid"
}
----

[source]
----
include::{snippet}[tag=query-where,indent=0]
----

==== Collection Operators

{url-api-references}/com/couchbase/lite/ArrayFunction.html[Collection operators] are useful to check if a given value is present in an array.

===== CONTAINS Operator

The following example uses the `Function.arrayContains` to find documents whose `public_likes` array property contain a value equal to "Armani Langworth".

[source,json]
----
{
    "_id": "hotel123",
    "name": "Apple Droid",
    "public_likes": ["Armani Langworth", "Elfrieda Gutkowski", "Maureen Ruecker"]
}
----

[source]
----
include::{snippet}[tag=query-collection-operator-contains,indent=0]
----

===== IN Operator

The `IN` operator is useful when you need to explicitly list out the values to test against.
The following example looks for documents whose `first`, `last` or `username` property value equals "Armani".

[source]
----
include::{snippet}[tag=query-collection-operator-in,indent=0]
----

==== Like Operator

The {url-api-references}/com/couchbase/lite/Expression.html#like-com.couchbase.lite.Expression-[`like`] operator can be used for string matching.

The `like` operator performs **case sensitive** matches.
So if you want to make the string matching case insensitive, you would have to use `Function.lower` or `Function.upper` to transform the matched string to lowercase or uppercase equivalents.

In the example below, we are looking for documents of type `landmark` where the name property exactly matches the string "Royal engineers museum".
Note that since `like` does a case sensitive match, we use `Function.lower` to transform the matched string to the lowercase equivalent.
So the following query will return "landmark" type documents with the name matching "Royal Engineers Museum", "royal engineers museum", "ROYAL ENGINEERS MUSEUM" and so on.

[source]
----
include::{snippet}[tag=query-like-operator,indent=0]
----

==== Wildcard Match

We can use `%` sign within a `like` expression to do a wildcard match against zero or more characters.
Using wildcards allows you to have some fuzziness in your search string.

In the example below, we are looking for documents of `type` "landmark" where the name property matches any string that begins with "eng" followed by zero or more characters, the letter "e", followed by zero or more characters.
Once again, we are using `Function.lower` to make the search case insensitive.

The following query will return "landmark" `type` documents with name matching "Engineers", "engine", "english egg" , "England Eagle" and so on.
Notice that the matches may span word boundaries.

[source]
----
include::{snippet}[tag=query-like-operator-wildcard-match,indent=0]
----

==== Wildcard Character Match

We can use an `_` sign within a like expression to do a wildcard match against a single character.

In the example below, we are looking for documents of type "landmark" where the `name` property matches any string that begins with "eng" followed by exactly 4 wildcard characters and ending in the letter "r".
The following query will return "landmark" `type` documents with the `name` matching "Engineer", "engineer" and so on.

[source]
----
include::{snippet}[tag=query-like-operator-wildcard-character-match,indent=0]
----

==== Regex Operator

Similar to wildcard `like` expressions, `regex` expressions based pattern matching allow you to have some fuzziness in your search string.

The `regex` operator is case sensitive.

In the example below, we are looking for documents of `type` "landmark" where the name property matches any string (on word boundaries) that begins with "eng" followed by exactly 4 wildcard characters and ending in the letter "r".
The following query will return "landmark" type documents with name matching "Engine", "engine" and so on.
Note that the `\b` specifies that the match must occur on word boundaries.

[source]
----
include::{snippet}[tag=query-regex-operator,indent=0]
----

==== Deleted Document

Starting in Couchbase Lite 2.5, you can query documents that have been deleted (tombstones).
The following example shows how to query deleted documents in the database.

[source]
----
include::{snippet}[tag=query-deleted-documents,indent=0]
----

=== JOIN statement

The JOIN clause enables you to create new input objects by combining two or more source objects.

The following example uses a JOIN clause to find the airline details which have routes that start from RIX.
This example JOINS the document of type "route" with documents of type "airline" using the document ID (`_id`) on the "airline" document and `airlineid` on the "route" document.

[source]
----
include::{snippet}[tag=query-join,indent=0]
----

=== GROUP BY statement

You can perform further processing on the data in your result set before the final projection is generated.
The following example looks for the number of airports at an altitude of 300 ft or higher and groups the results by country and timezone.

[source,json]
----
{
    "_id": "airport123",
    "type": "airport",
    "country": "United States",
    "geo": { "alt": 456 },
    "tz": "America/Anchorage"
}
----

[source]
----
include::{snippet}[tag=query-groupby,indent=0]
----

[source,text]
----
There are 138 airports on the Europe/Paris timezone located in France and above 300 ft
There are 29 airports on the Europe/London timezone located in United Kingdom and above 300 ft
There are 50 airports on the America/Anchorage timezone located in United States and above 300 ft
There are 279 airports on the America/Chicago timezone located in United States and above 300 ft
There are 123 airports on the America/Denver timezone located in United States and above 300 ft
----

=== ORDER BY statement

It is possible to sort the results of a query based on a given expression result.
The example below returns documents of type equal to "hotel" sorted in ascending order by the value of the title property.

[source]
----
include::{snippet}[tag=query-orderby,indent=0]
----

[source,text]
----
Aberdyfi
Achiltibuie
Altrincham
Ambleside
Annan
Ardèche
Armagh
Avignon
----

=== Date/Time Functions

include::partial$query/date-time-functions.adoc[]

== Live Query

include::partial$live-query.adoc[]

== Predictive Query

include::partial$predictive-query.adoc[]

== Indexing

Creating indexes can speed up the performance of queries.
While indexes make queries faster, they also make writes slightly slower, and the Couchbase Lite database file slightly larger.
As such, it is best to only create indexes when you need to optimize a specific case for better query performance.

The following example creates a new index for the `type` and `name` properties.

[source,json]
----
{
    "_id": "hotel123",
    "type": "hotel",
    "name": "Apple Droid"
}
----

[source]
----
include::{snippet}[tag=query-index,indent=0]
----

If there are multiple expressions, the first one will be the primary key, the second the secondary key, etc.

NOTE: Every index has to be updated whenever a document is updated, so too many indexes can hurt performance.
Thus, good performance depends on designing and creating the _right_ indexes to go along with your queries.

== Full-Text Search

To run a full-text search (FTS) query, you must have created a full-text index on the expression being matched.
Unlike regular queries, the index is not optional.
The following example inserts documents and creates an FTS index on the `name` property.

[source]
----
include::{snippet}[tag=fts-index,indent=0]
----

Multiple properties to index can be specified in the index creation method.

With the index created, an FTS query on the property that is being indexed can be constructed and ran.
The full-text search criteria is defined as a `FullTextExpression`.
The left-hand side is the full-text index to use and the right-hand side is the pattern to match.

[source]
----
include::{snippet}[tag=fts-query,indent=0]
----

In the example above, the pattern to match is a word, the full-text search query matches all documents that contain the word "buy" in the value of the `doc.name` property.

Search is supported for all languages that use whitespace to separate words.

Stemming, which is the process of fuzzy matching parts of speech, like "fast" and "faster", is supported in the following languages: danish, dutch, english, finnish, french, german, hungarian, italian, norwegian, portuguese, romanian, russian, spanish, swedish and turkish.

The pattern to match can also be in the following forms:

prefix queries::
The query expression used to search for a term prefix is the prefix itself with a "*" character appended to it.
For example:
+
....
"'lin*'"
-- Query for all documents containing a term with the prefix "lin". This will match
-- all documents that contain "linux", but also those that contain terms "linear",
--"linker", "linguistic" and so on.
....

overriding the property name that is being indexed::
Normally, a token or token prefix query is matched against the document property specified as the left-hand side of the `match` operator.
This may be overridden by specifying a property name followed by a ":" character before a basic term query.
There may be space between the ":" and the term to query for, but not between the property name and the ":" character.
For example:
+
....
'title:linux problems'
-- Query the database for documents for which the term "linux" appears in
-- the document title, and the term "problems" appears in either the title
-- or body of the document.
....

phrase queries::
A phrase query is a query that retrieves all documents that contain a nominated set of terms or term prefixes in a specified order with no intervening tokens.
Phrase queries are specified by enclosing a space separated sequence of terms or term prefixes in double quotes (").
For example:
+
....
"'"linux applications"'"
-- Query for all documents that contain the phrase "linux applications".
....

NEAR queries::
A NEAR query is a query that returns documents that contain a two or more nominated terms or phrases within a specified proximity of each other (by default with 10 or less intervening terms).
A NEAR query is specified by putting the keyword "NEAR" between two phrase, token or token prefix queries.
To specify a proximity other than the default, an operator of the form "NEAR/" may be used, where is the maximum number of intervening terms allowed.
For example:
+
....
"'database NEAR/2 "replication"'"
-- Search for a document that contains the phrase "replication" and the term
-- "database" with not more than 2 terms separating the two.
....

AND, OR & NOT query operators::
The enhanced query syntax supports the AND, OR and NOT binary set operators.
Each of the two operands to an operator may be a basic FTS query, or the result of another AND, OR or NOT set operation.
Operators must be entered using capital letters.
Otherwise, they are interpreted as basic term queries instead of set operators.
For example:
+
....
'couchbase AND database'
-- Return the set of documents that contain the term "couchbase", and the
-- term "database". This query will return the document with docid 3 only.
....
+
When using the enhanced query syntax, parenthesis may be used to specify the precedence of the various operators.
For example:
+
....
'("couchbase database" OR "sqlite library") AND linux'
-- Query for the set of documents that contains the term "linux", and at least
-- one of the phrases "couchbase database" and "sqlite library".
....

=== Ordering results

It's very common to sort full-text results in descending order of relevance.
This can be a very difficult heuristic to define, but Couchbase Lite comes with a ranking function you can use.
In the `OrderBy` array, use a string of the form `Rank(X)`, where `X` is the property or expression being searched, to represent the ranking of the result.

== Replication

include::partial$replication-introduction.adoc[]

=== Compatibility

WARNING: The new protocol is *incompatible* with CouchDB-based databases.
And since Couchbase Lite 2 only supports the new protocol, you will need to run a version of Sync Gateway that xref:sync-gateway::compatibility-matrix.adoc[supports it].

To use this protocol with Couchbase Lite 2.0, the replication URL should specify WebSockets as the URL scheme (see the <<Starting a Replication>> section below).
Mobile clients using Couchbase Lite 1.x can continue to use *http* as the URL scheme.
Sync Gateway 2.0 will automatically use the 1.x replication protocol when a Couchbase Lite 1.x client connects through \http://localhost:4984/db and the 2.0 replication protocol when a Couchbase Lite 2.0 client connects through "ws://localhost:4984/db".

=== Starting Sync Gateway

https://www.couchbase.com/downloads[Download Sync Gateway] and start it from the command line with the configuration file created above.

[source,bash]
----
~/Downloads/couchbase-sync-gateway/bin/sync_gateway
----

For platform specific installation instructions, refer to the Sync Gateway xref:sync-gateway::getting-started.adoc#installation[installation guide].

=== Starting a Replication

Replication can be bidirectional, this means you can start a `push`/`pull` replication with a single instance.
The replication's parameters can be specified through the {url-api-references}/index.html?com/couchbase/lite/ReplicatorConfiguration.html[`ReplicatorConfiguration`] object;
for example, if you wish to start a `push` only or `pull` only replication.

The following example creates a `pull` replication with Sync Gateway.

[source]
----
class MyClass {
    Database database;
    Replicator replicator; // <1>

    void startReplication() {
        URI uri = null;
        try {
            uri = new URI("wss://10.0.2.2:4984/db"); // <2>
        } catch (URISyntaxException e) {
            e.printStackTrace();
        }
        Endpoint endpoint = new URLEndpoint(uri);
        ReplicatorConfiguration config = new ReplicatorConfiguration(database, endpoint);
        config.setReplicatorType(ReplicatorConfiguration.ReplicatorType.PULL);
        this.replicator = new Replicator(config);
        this.replicator.start();
    }

}
----
<1> A replication is an asynchronous operation.
To keep a reference to the `replicator` object, you can set it as an instance property.
<2> The URL scheme for remote database URLs has changed in Couchbase Lite 2.0.
You should now use `ws:`, or `wss:` for SSL/TLS connections.
In this example the hostname is `10.0.2.2` because the Android emulator runs in a VM that is generally accessible on `10.0.2.2` from the host machine (see https://developer.android.com/studio/run/emulator-networking[Android Emulator networking] documentation).
+
NOTE: As of Android Pie, version 9, API 28, cleartext support is disabled, by default.
Although `wss:` protocol URLs are not affected, in order to use the `ws:` protocol, applications must target API 27 or lower, or must configure application network security as described https://developer.android.com/training/articles/security-config#CleartextTrafficPermitted[here].

include::partial$verify-replication.adoc[]

Couchbase Lite 2.0 uses WebSockets as the communication protocol to transmit data.
Some load balancers are not configured for WebSocket connections by default (NGINX for example);
so it might be necessary to explicitly enable them in the load balancer's configuration (see xref:sync-gateway::load-balancer.adoc[Load Balancers]).

By default, the WebSocket protocol uses compression to optimize for speed and bandwidth utilization.
The level of compression is set on Sync Gateway and can be tuned in the configuration file (xref:sync-gateway::config-properties.adoc#replicator_compression[`replicator_compression`]).

==== Replication Ordering

To optimize for speed, the replication protocol doesn't guarantee that documents will be received in a particular order.
So we don't recommend to rely on that when using the replication or database change listeners for example.

==== Replicator Notifications on a Custom Executor

Prior to version 2.6, Couchbase Lite spun up multiple executors.
This policy could result in too many threads being spun up.

An executor manages a pool of threads and, perhaps, a queue in front of the executor, to handle the asynchronous callbacks.
Couchbase Lite API calls which are processed by an executor are listed below.

[source]
----
Query.addChangeListener
MessageEndpointListerner.addChangeListener
LiveQuery.addChangeListener
AbstractReplicator.addDocumentReplicationListener
AbstractReplicator.addChangeListener
Database.addChangeListener
Database.addDocumentChangeListener
Database.addDatabaseChangeListener
Database.addChangeListener
----

As of version 2.6, Couchbase sometimes uses its own internal executor to run asynchronous client code.
While this is fine for small tasks, larger tasks -- those that take significant compute time, or that perform I/O -- can block Couchbase processing.
If this happens your application will fail with a `RejectedExecutionException` and it may be necessary to create a separate executor on which to run the large tasks.

The following examples show how to specify a separate executor in the client code.
The client code executor can enforce an application policy for delivery ordering and the number of threads.

*Guaranteed Order Delivery*

[source,java]
----
/**
 * This version guarantees in order delivery and is parsimonious with space
 * The listener does not need to be thread safe (at least as far as this code is concerned).
 * It will run on only thread (the Executor's thread) and must return from a given call
 * before the next call commences.  Events may be delivered arbitrarily late, though,
 * depending on how long it takes the listener to run.
 */
public class InOrderExample {
    private static final ExecutorService IN_ORDER_EXEC = Executors.newSingleThreadExecutor();

    public Replicator runReplicator(Database db1, Database db2, ReplicatorChangeListener listener)
        throws CouchbaseLiteException {
        ReplicatorConfiguration config = new ReplicatorConfiguration(db1, new DatabaseEndpoint(db2));
        config.setReplicatorType(ReplicatorConfiguration.ReplicatorType.PUSH_AND_PULL);
        config.setContinuous(false);

        Replicator repl = new Replicator(config);
        ListenerToken token = repl.addChangeListener(IN_ORDER_EXEC, listener::changed);

        repl.start();

        return repl;
    }
}
----

*Maximum Throughput*

[source,]
----
/**
 * This version maximizes throughput.  It will deliver change notifications as quickly
 * as CPU availability allows. It may deliver change notifications out of order.
 * Listeners must be thread safe because they may be called from multiple threads.
 * In fact, they must be re-entrant because a given listener may be running on mutiple threads
 * simultaneously.  In addition, when notifications swamp the processors, notifications awaiting
 * a processor will be queued as Threads, (instead of as Runnables) with accompanying memory
 * and GC impact.
 */
public class MaxThroughputExample {
    private static final ExecutorService MAX_THROUGHPUT_EXEC = Executors.newCachedThreadPool();

    public Replicator runReplicator(Database db1, Database db2, ReplicatorChangeListener listener)
        throws CouchbaseLiteException {
        ReplicatorConfiguration config = new ReplicatorConfiguration(db1, new DatabaseEndpoint(db2));
        config.setReplicatorType(ReplicatorConfiguration.ReplicatorType.PUSH_AND_PULL);
        config.setContinuous(false);

        Replicator repl = new Replicator(config);
        ListenerToken token = repl.addChangeListener(MAX_THROUGHPUT_EXEC, listener::changed);

        repl.start();

        return repl;
    }
}
----

*Extreme Configurability*

[source]
----
/**
 * This version demonstrates the extreme configurability of the CouchBase Lite replicator callback system.
 * It may deliver updates out of order and does require thread-safe and re-entrant listeners
 * (though it does correctly synchronizes tasks passed to it using a SynchronousQueue).
 * The thread pool executor shown here is configured for the sweet spot for number of threads per CPU.
 * In a real system, this single executor might be used by the entire application and be passed to
 * this module, thus establishing a reasonable app-wide threading policy.
 * In an emergency (Rejected Execution) it lazily creates a backup executor with an unbounded queue
 * in front of it.  It, thus, may deliver notifications late, as well as out of order.
 */
public class PolicyExample {
    private static final int CPUS = Runtime.getRuntime().availableProcessors();

    private static ThreadPoolExecutor BACKUP_EXEC;

    private static final RejectedExecutionHandler BACKUP_EXECUTION
        = new RejectedExecutionHandler() {
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            synchronized (this) {
                if (BACKUP_EXEC == null) { BACKUP_EXEC = createBackupExecutor(); }
            }
            BACKUP_EXEC.execute(r);
        }
    };

    private static ThreadPoolExecutor createBackupExecutor() {
        ThreadPoolExecutor exec
            = new ThreadPoolExecutor(CPUS + 1, 2 * CPUS + 1, 30, TimeUnit.SECONDS, new LinkedBlockingQueue<Runnable>());
        exec.allowCoreThreadTimeOut(true);
        return exec;
    }

    private static final ThreadPoolExecutor STANDARD_EXEC
        = new ThreadPoolExecutor(CPUS + 1, 2 * CPUS + 1, 30, TimeUnit.SECONDS, new SynchronousQueue<Runnable>());

    static { STANDARD_EXEC.setRejectedExecutionHandler(BACKUP_EXECUTION); }

    public Replicator runReplicator(Database db1, Database db2, ReplicatorChangeListener listener)
        throws CouchbaseLiteException {
        ReplicatorConfiguration config = new ReplicatorConfiguration(db1, new DatabaseEndpoint(db2));
        config.setReplicatorType(ReplicatorConfiguration.ReplicatorType.PUSH_AND_PULL);
        config.setContinuous(false);

        Replicator repl = new Replicator(config);
        ListenerToken token = repl.addChangeListener(STANDARD_EXEC, listener::changed);

        repl.start();

        return repl;
    }
}
----

=== Troubleshooting

As always, when there is a problem with replication, logging is your friend.
The following example increases the log output for activity related to replication with Sync Gateway.

[source]
----
include::{snippet}[tag=replication-logging,indent=0]
----

=== Authentication

include::partial$authentication.adoc[]

=== Replication Status

The `replication.Status.Activity` property can be used to check the status of a replication.
For example, when the replication is actively transferring data and when it has stopped.

[source]
----
include::{snippet}[tag=replication-status,indent=0]
----

The following table lists the different activity levels in the API and the meaning of each one.

[cols="1,2"]
|===
|State |Meaning

|`STOPPED`
|The replication is finished or hit a fatal error.

|`OFFLINE`
|The replicator is offline as the remote host is unreachable.

|`CONNECTING`
|The replicator is connecting to the remote host.

|`IDLE`
|The replication caught up with all the changes available from the server.
The `IDLE` state is only used in continuous replications.

|`BUSY`
|The replication is actively transferring data.
|===

NOTE: The replication change object also has properties to track the progress (`change.status.completed` and `change.status.total`).
But since the replication occurs in batches and the total count can vary through the course of a replication, those progress indicators are not very useful from the standpoint of an app user.
Hence, these should not be used for tracking the actual progress of the replication.

anchor:repstatus-and-lifecycle[]

==== Replication Status and App Lifecycle

Couchbase Lite replications will continue running until the app terminates, unless the remote system, or the application, terminates the connection.

NOTE: Recall that the Android OS may kill an application without warning.
You should explicitly stop replication processes when they are no longer useful (for example, when they are `suspended` or `idle`) to avoid socket connections being closed by the OS, which may interfere with the replication process.

=== Handling Network Errors

If an error occurs, the replication status will be updated with an `Error` which follows the standard HTTP error codes.
The following example monitors the replication for errors and logs the error code to the console.

[source]
----
include::{snippet}[tag=replication-error-handling,indent=0]
----

When a permanent error occurs (i.e., `404`: not found, `401`: unauthorized), the replicator (continuous or one-shot) will stop permanently.
If the error is temporary (i.e., waiting for the network to recover), a continuous replication will retry to connect indefinitely and if the replication is one-shot it will retry for a limited number of times.
The following error codes are considered temporary by the Couchbase Lite replicator and thus will trigger a connection retry.

* `408`: Request Timeout
* `429`: Too Many Requests
* `500`: Internal Server Error
* `502`: Bad Gateway
* `503`: Service Unavailable
* `504`: Gateway Timeout
* `1001`: DNS resolution error

=== Replication Events

include::partial$replication-events.adoc[]

=== Custom Headers

include::partial$replication-custom-header.adoc[]

[source]
----
include::{snippet}[tag=replication-custom-header,indent=0]
----

=== Replication Checkpoint Reset

include::partial$replication-checkpoint.adoc[]

[source]
----
include::{snippet}[tag=replication-reset-checkpoint,indent=0]
----

=== Replication Filters

include::partial$replication-filters.adoc[]

== Handling Conflicts

include::partial$handling-conflicts.adoc[]

== Database Replicas

include::partial$database-replicas.adoc[]

== Certificate Pinning

include::partial$certificate-pinning.adoc[]

== Peer-to-Peer Sync

.Enterprise Edition only
IMPORTANT: Peer-to-peer sync is an https://www.couchbase.com/products/editions[Enterprise Edition] feature.
You must purchase the Enterprise License which includes official https://www.couchbase.com/support-policy[Couchbase Support] to use it in production (also see the https://www.couchbase.com/licensing-and-support-faq[FAQ]).

Peer-to-peer sync allows devices running Couchbase Lite to directly sync data with each other.
As part of this, Couchbase Lite is responsible for storing the data and keeping track of the data exchange, but isn't responsible for the data transfer itself.
Sending and receiving data must be handled by the platform APIs or a third party framework.
In this section, we will refer to these third party frameworks as communication frameworks.

On Android, the https://developers.google.com/nearby/messages/overview[Nearby Messages API] would be a good choice for the Communication Framework.
This framework will handle sending and receiving messages and supports multiple transport technologies -- WiFi and Bluetooth and uses whichever is available to establish a connection between devices.

Thus, to enable peer-to-peer sync with Couchbase Lite, the application must use the Communication Framework with Couchbase Lite.
The following sections describe a typical peer-to-peer workflow.
Where applicable, we discuss how to integrate Couchbase Lite into the workflow.

In Couchbase Lite, a peer can take on one of these two roles:

* *Active Peer:* The peer that initializes the connection and replication (i.e the "client" side).
* *Passive Peer:* The passive side reacts to things that it receives but does not initiate any communication on its own (i.e. the "server" side).

=== Peer Discovery

include::partial$p2p-peer-discovery.adoc[]

=== Peer Selection and Connection Setup

include::partial$p2p-peer-selection.adoc[]

=== Replication Setup

include::partial$p2p-replication-setup.adoc[]

=== Push/Pull Replication

include::partial$p2p-push-pull-repl.adoc[]

=== Connection Teardown

include::partial$p2p-connection-teardown.adoc[]

== Thread Safety

The Couchbase Lite API is thread safe except for calls to mutable objects: `MutableDocument`, `MutableDictionary` and `MutableArray`.

== Release Notes

=== 2.7.1

Note: Support notices remain in force for this maintenance release -- see <<support-notices, Support Notices>> below.

==== {fixed}

This maintenance release fixes the following issues:

* https://issues.couchbase.com/browse/CBL-799[*CBL-799*] Crash calling pull validator callback
* https://issues.couchbase.com/browse/CBL-789[*CBL-789*] Crash when accessing `connection->name()`
* https://issues.couchbase.com/browse/CBL-701[*CBL-701*] Pending Document IDs not working correctly
* https://issues.couchbase.com/browse/CBL-698[*CBL-698*] Wrong query evaluation using expression values instead of expression properties
* https://issues.couchbase.com/browse/CBL-657[*CBL-657*] LIKE and CONTAINS are much slower in 2.7
* https://issues.couchbase.com/browse/CBL-581[*CBL-581*] Native memory leak when save document repeatedly​
* https://issues.couchbase.com/browse/CBL-579[*CBL-579*] SDK fails for opening Database files over 2GB

==== {ke}

The following issues document known errors:

* https://issues.couchbase.com/browse/CBL-608[*CBL-608*] Ordering null values inconsistent with N1QL expectations
* https://issues.couchbase.com/browse/CBL-370[*CBL-370*] 370	Broken API, Kotlin: Unable to import ReplicatorType
* https://issues.couchbase.com/browse/CBL-216[*CBL-216*] Ordering null values inconsistent with N1QL expectations
* https://issues.couchbase.com/browse/CBL-95[*CBL-95*] Pending conflicts could be resolved by a wrong replicator
* https://issues.couchbase.com/browse/CBL-49[*CBL-49*] Need a way to distinguish boolean types

=== 2.7.0

*{nftr}*

New at this release is the Java Platform, which enables development of Java apps on any platform that supports the JVM model

xref::index.adoc[{more}]

[#support-notices]
*Support Notices*

:msg_component: API 19 and 21
:msg_action:  Please plan to migrate your apps to use API versions greater than API 21
:msg_release: 2.6
:msg_endRel: 2.9
include::_partials/deprecationNotice.adoc[]

See also <<Supported Versions>>

*{ke}*

- https://issues.couchbase.com/browse/CBL-608[*CBL-608*]	Blob missing content file
- https://issues.couchbase.com/browse/CBL-564[*CBL-564*]	Property alias not working under certain cases
- https://issues.couchbase.com/browse/CBL-370[*CBL-370*] Broken API, Kotlin: Unable to import ReplicatorType
- https://issues.couchbase.com/browse/CBL-216[*CBL-216*] Ordering null values inconsistent with N1QL expectations
- https://issues.couchbase.com/browse/CBL-95[*CBL-95*] Pending conflicts could be resolved by a wrong replicator
- https://issues.couchbase.com/browse/CBL-49[*CBL-49*] Need a way to distinguish boolean types

*{fixed}*

// - https://issues.couchbase.com/browse/CBL-562[*CBL-562*] Can't open existing db read-only; LiteCore test "Database Open Older Encrypted" fails
// - https://issues.couchbase.com/browse/CBL-550[*CBL-550*] SQLite index creation mistakenly sets user_version backwards
// - https://issues.couchbase.com/browse/CBL-536[*CBL-536*] Long delay starting replicator, for big databases
// - https://issues.couchbase.com/browse/CBL-527[*CBL-527*] RefCount crash
// - https://issues.couchbase.com/browse/CBL-525[*CBL-525*] Upgrade from 1.x fails if any docID starts with "_"
- https://issues.couchbase.com/browse/CBL-478[*CBL-478*] Better handling of RejectedExecutionExceptions
- https://issues.couchbase.com/browse/CBL-469[*CBL-469*] Infinite loop parsing a URL
// - https://issues.couchbase.com/browse/CBL-466[*CBL-466*] [Android] enable file logging - setConfig failed if called more than once
- https://issues.couchbase.com/browse/CBL-463[*CBL-463*] Attempt to log strings that are not Modified UTF-8
- https://issues.couchbase.com/browse/CBL-444[*CBL-444*] Purging documents does not fire events in a QueryChangeListener
- https://issues.couchbase.com/browse/CBL-436[*CBL-436*] Crash finding keys in and empty dictionary
// - https://issues.couchbase.com/browse/CBL-415[*CBL-415*] strod produces locale-dependent results for encoding Fleece
- https://issues.couchbase.com/browse/CBL-404[*CBL-404*] Static maps in C4Socket are gigantic memory leaks
- https://issues.couchbase.com/browse/CBL-402[*CBL-402*] Back-tag recent releases
// - https://issues.couchbase.com/browse/CBL-400[*CBL-400*] Not getting right number of revisions on SGW while using multiple SGWS
- https://issues.couchbase.com/browse/CBL-392[*CBL-392*] Incorrect data sent for attachment with digest...
// - https://issues.couchbase.com/browse/CBL-390[*CBL-390*] Blob constructor silently truncates stream arguments
- https://issues.couchbase.com/browse/CBL-355[*CBL-355*] Queries silently ignore Collation Locale
- https://issues.couchbase.com/browse/CBL-346[*CBL-346*] Creating revisions out-of-orders sequence numbers
// - https://issues.couchbase.com/browse/CBL-343[*CBL-343*] LiteCore tests need to use unique database
- https://issues.couchbase.com/browse/CBL-324[*CBL-324*] Function.upper() failed to operate non-ASCII characters
- https://issues.couchbase.com/browse/CBL-272[*CBL-272*] MessageSocketFactory.socket_open() is not accessible by C4Socket
// - https://issues.couchbase.com/browse/CBL-253[*CBL-253*] Automated tests take a 2 minutes, each, to complete
- https://issues.couchbase.com/browse/CBL-242[*CBL-242*] Inconsistent revision hash length
// - https://issues.couchbase.com/browse/CBL-241[*CBL-241*] Fix the constructor `MutableDocument(Document)`
// - https://issues.couchbase.com/browse/CBL-234[*CBL-234*] Release ResultSet when LiveQuery is stopped may cause unexpected behavior
- https://issues.couchbase.com/browse/CBL-221[*CBL-221*] "mutex lock failed" during initial pull replication of large # of docs
- https://issues.couchbase.com/browse/CBL-218[*CBL-218*] FTS indexing an array-valued property is unreliable
- https://issues.couchbase.com/browse/CBL-207[*CBL-207*] Replicator change event has idle with timeout error
- https://issues.couchbase.com/browse/CBL-205[*CBL-205*] Crash when stopping replication during sync
// - https://issues.couchbase.com/browse/CBL-175[*CBL-175*] Can't query the records has the % character with LIKE operator.
- https://issues.couchbase.com/browse/CBL-174[*CBL-174*] Local reference table overflow
- https://issues.couchbase.com/browse/CBL-172[*CBL-172*] Live Query initial delay
- https://issues.couchbase.com/browse/CBL-171[*CBL-171*] CBL replication never finishes for replication filtering when doc count is 1000
- https://issues.couchbase.com/browse/CBL-144[*CBL-144*] Incorrect log level passed to custom logger
- https://issues.couchbase.com/browse/CBL-143[*CBL-143*] Default logging flooded with C4Socket warning messages
// - https://issues.couchbase.com/browse/CBL-126[*CBL-126*] Litecore does not retry subChanges request that fails with temporary 503 error
- https://issues.couchbase.com/browse/CBL-106[*CBL-106*] Replicator C++ exception: "properties excessively large"
- https://issues.couchbase.com/browse/CBL-52[*CBL-52*] “LIKE”, "CONTAINS", "REGEX_LIKE" operators ignore collations
- https://issues.couchbase.com/browse/CBL-34[*CBL-34*] Replicator crash
- https://issues.couchbase.com/browse/CBL-13[*CBL-13*] Native crash

=== 2.6.2

This maintenance release for Android includes important bug fixes.

*Bugs*

* https://issues.couchbase.com/browse/CBL-468[*CBL-468*] Null dereference during pull-only replication.
* https://issues.couchbase.com/browse/CBL-467[*CBL-467*] Replication listener sometimes crashed on NPE.
* https://issues.couchbase.com/browse/CBL-436[*CBL-436*] An attempt to get the keys from an empty dictionary caused a crash.
* https://issues.couchbase.com/browse/CBL-324[*CBL-324*] Function.upper() failed to operate non-ASCII characters.
* https://issues.couchbase.com/browse/CBL-172[*CBL-172*] Initial delay observed when starting a liveQuery has been fixed.
* https://issues.couchbase.com/browse/CBL-34[*CBL-34*] Fixed a replicator crash issue.


=== 2.6.0

*{nftr}*

* Custom Conflict Resolution
+
xref:index.adoc[{more}]

*{enh}*

* Expose the Document Revision ID: the `revisionID` property on a `Document` instance now returns the current revision identifier.

*Android API Support*

:msg_component: API 19 and 21
:msg_action:  Please plan to migrate your apps to use API versions greater than API 21
:msg_release: 2.6
include::_partials/deprecationNotice.adoc[]

*{api}*

* The constructor `DatabaseConfiguration(Context)` no longer exists.  It has been replaced by `DatabaseConfiguration()`.
* The static method `CouchbaseLite.init(Context)` must be called before *any* other method in the Couchbase Lite API.
Applications upgrading from earlier versions to 2.6 must invoke this method.

{more} in the <<initializer>> section.


*Bugs*

* https://issues.couchbase.com/browse/CBL-48[*CBL-48*] Copy method of Database class is not able to copy encrypted db.
* https://issues.couchbase.com/browse/CBL-86[*CBL-86*] Race condition on SharedKeys causes silent error.
* https://issues.couchbase.com/browse/CBL-71[*CBL-71*] LiteCore database alias clashes with select all alias.
* https://issues.couchbase.com/browse/CBL-88[*CBL-88*] Calling Replicator#getStatus() on a replicator that hasn't started throws NPE.
* https://issues.couchbase.com/browse/CBL-89[*CBL-89*] Calling Replicator#stop() on a replicator that hasn't started throws NPE.
* https://issues.couchbase.com/browse/CBL-130[*CBL-130*] Crash: Possible memory corruption.
* https://issues.couchbase.com/browse/CBL-165[*CBL-165*] Replication failed due to unauthorized(401) error.

*{ke}*

- https://issues.couchbase.com/browse/CBL-324[*CBL-324*] Function.upper() failed to operate non-ASCII characters
- https://issues.couchbase.com/browse/CBL-95[*CBL-95*] Pending conflicts could be resolved by a wrong replicator
- https://issues.couchbase.com/browse/CBL-49[*CBL-49*] Need a way to distinguish boolean types

=== 2.5.3

*{enh}*

* https://issues.couchbase.com/browse/CBL-142[*CBL-142*] Added native support for x86_64.

{fixed}

* https://issues.couchbase.com/browse/CBL-176[*CBL-176*] Reduce replication timeouts.
* https://issues.couchbase.com/browse/CBL-110[*CBL-110*] Delta sync on top of a deletion caused data discrepancy between Couchbase Sync Gateway and Couchbase Lite.
* https://issues.couchbase.com/browse/CBL-131[*CBL-131*] Continuous replicator does not back off retries.

=== 2.5.2

{fixed}

* https://github.com/couchbase/couchbase-lite-core/issues/776[*#776*] `c4db_endTransaction` sometimes results in invalid memory access.
* https://github.com/couchbase/couchbase-lite-core/issues/787[*#787*] Fleece error when querying array property.
* https://github.com/couchbase/couchbase-lite-core/issues/792[*#792*] DBWorker crashes in Fleece Encoder (writePointer).
* https://issues.couchbase.com/browse/CBL-5[*CBL-5*] Excessive synchronization is stalling Live Query notification.

=== 2.5.0

*{nftr}*

* Delta Sync
* Replication Filters
* Continuous Logging
* Predictive Query
+
xref:index.adoc[{more}]

*{enh}*

* {url-issues-java}/1779[*#1779*]
Replication Filters
* {url-issues-java}/1821[*#1821*]
Remove log rotation change batching
* {url-issues-java}/1845[*#1845*]
Annotate @NonNull to public API

{fixed}

* {url-issues-java}/1523[*#1523*]
2.0: ``isOldAttachment'' check is incorrect
* {url-issues-java}/1755[*#1755*]
Query enumeration error: LiteCoreException
* {url-issues-java}/1756[*#1756*]
2.0 Replicator does not work with TLS 1.2 when using Android API <= 19
* {url-issues-java}/1785[*#1785*]
Result.toMap() does not return boolean values
* {url-issues-java}/1814[*#1814*]
Change domains type of the Console Logger to EnumSet
* {url-issues-java}/1818[*#1818*]
Crash on document save with 2.1.2
* {url-issues-java}/1872[*#1872*]
Logging messages CBL code are not shown up in console
* {url-issues-java}/1899[*#1899*]
Signal 11 SIGSEGV with current iridium Branch
* {url-issues-java}/1900[*#1900*]
BlobInputStream does not return -1 when finished reading
* {url-issues-java}/1904[*#1904*]
Signal 11 SIGSEGV when initiating Dictionary Iterator

*{ke}*

* {url-issues-java}/1773[*#1773*]
Client Proxy Support
* {url-issues-java}/1888[*#1888*]
Memory Leak: Database reference held by a ReplicatorListenerThread after
close

=== 2.1.2

.{fixed}
* {url-issues-java}/1760[*#1760*] Warning about CBLWebSocket failed to shutdown the web socket
* {url-issues-java}/1761[*#1761*] Could not find class `android.system.ErrnoException' error
* {url-issues-java}/1762[*#1762*] Potential memory leak in replicator
* {url-issues-java}/1763[*#1763*] Log from replicator’s native code shouldn’t be shown unless the logging is enabled
* {url-issues-java}/1766[*#1766*] Auth Header from BasicAuthenticator not getting sent if SG Guest user is enabled

=== 2.1

.{enh}
* {url-issues-java}/1678[*#1678*] Support Peer-to-Peer replication through MessageEndpoint API (EE Feature)
* {url-issues-java}/1683[*#1683*] Support Database Encryption (EE feature)
* {url-issues-java}/1696[*#1696*] Support replicator reset checkpoint

.{fixed}
* {url-issues-java}/1510[*#1510*] 2.0: Crash with DB21 - in c4doc_update()
* {url-issues-java}/1665[*#1665*] Exception thrown openDatabase (Proguard strips methods that CBL uses)
* {url-issues-java}/1676[*#1676*] 2.0: Replicator Error misses the error message.
* {url-issues-java}/1702[*#1702*] 2.x: ValueIndexItem.expression(Expression) is missing
* {url-issues-java}/1725[*#1725*] 2.1: Android : Replication does not start
* {url-issues-java}/1727[*#1727*] Dead lock occurs - DB 2.0.0
* {url-issues-java}/1742[*#1742*] Couchbase mobile 2.0.2 Emoji Support

.{ke}
* {url-issues-java}/1743[*#1743*] HTTP Proxy Support

=== 2.0.2

* Support for Log redaction of sensitive information when <<Logging,logging is enabled>>.

=== 2.0.0

.{enh}
* {url-issues-java}/1264[*#1264*] 2.0 migration from Forest back to SQlite
* {url-issues-java}/1577[*#1577*] 2.1: Eliminate CouchbaseLiteRuntimeExecption, convert it to CouchbaseLiteExecption

.{fixed}
* {url-issues-java}/1217[*#1217*] 2.0: Todo Sample bug Fix and implement remaining features
* {url-issues-java}/1234[*#1234*] 2.0: Replicator continuous pull status completed and total number out of sync
* {url-issues-java}/1247[*#1247*] 2.0: Push Replication Causing Errors
* {url-issues-java}/1273[*#1273*] 2.0: Replicator Activity Level stays in Busy state
* {url-issues-java}/1347[*#1347*] 2.0: How do we properly stop puller Replicator and delete database ?
* {url-issues-java}/1470[*#1470*] 2.0: In My App with CB Lite DB020(Android), ConflictResolver is called endless loop during three device or much more!
* {url-issues-java}/1499[*#1499*] 2.0: Repl Bad URL returns 19 instead of 15 on API 24 ARM emulator
* {url-issues-java}/1500[*#1500*] 2.0: LoadTest.testUpdate() causes memory error with Android API 19 Arm Emulator
* {url-issues-java}/1501[*#1501*] 2.0: ReplicatorTest > testPushDoc fails
* {url-issues-java}/1512[*#1512*] 2.0: ReplicatorTest > testPullDoc fails
* {url-issues-java}/1581[*#1581*] 2.0 : LiveQuery threading issue
* {url-issues-java}/1609[*#1609*] 2.0: testSelfSignedSSLPinned() unit test failure
* {url-issues-java}/1610[*#1610*] Exception from the cpp layer in my android app on load tests
* {url-issues-java}/1615[*#1615*] 2.0: NullPointerException: Attempt to invoke virtual method 'boolean com.couchbase.litecore.C4QueryEnumerator.next()' on a null object reference
* {url-issues-java}/1620[*#1620*] NOT operator not working for FTS
* {url-issues-java}/1630[*#1630*] 2.0: make public Index interface
* {url-issues-java}/1651[*#1651*] 2.0: C4DocumentTest.testPut() fails
* {url-issues-java}/1652[*#1652*] App crash with deleteDocument with concurrencyControl
* {url-issues-java}/1693[*#1693*] DB023 - Crazy amount of dbListenerTokens - makes the DB run slow

.{ke}
* {url-issues-java}/1685[*#1685*] Replicator in Android get stuck at busy state when it goes back to online from offline (Genymotion)
* {url-issues-java}/1702[*#1702*] ValueIndexItem.expression(Expression) is implemented with CBL Android 2.0.0 release.
This API will be available with 2.1.0 release
* {url-issues-java}/1665[*#1665*]: it is currently not possible to enable https://developer.android.com/studio/build/shrink-code.html[code shrinking] (`minifyEnabled: true`) in an Android Studio project that uses Couchbase Lite 2.0.
As a workaround, code shrinking can be disabled for Couchbase Lite classes and its dependencies by adding the following in *proguard-rules.pro*.
+
[source,groovy]
----
# OkHttp3
-dontwarn okhttp3.**
-dontwarn okio.**
-dontwarn javax.annotation.**
-dontwarn org.conscrypt.**
# A resource is loaded with a relative path so the package of this class must be preserved.
-keepnames class okhttp3.internal.publicsuffix.PublicSuffixDatabase

# CBL2.x
-keep class com.couchbase.litecore.**{ *; }
-keep class com.couchbase.lite.**{ *; }
----
