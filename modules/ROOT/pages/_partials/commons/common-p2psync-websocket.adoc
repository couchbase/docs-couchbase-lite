// = P2P Sync Using URLEndpointListener
// :page-layout: article
// :page-status:
// :page-edition: Under Development
// :page-role:
// :description: Couchbase mobile database queries - concepts
//
// include::partial$_std-cbl-hdr-android.adoc[]

// DO NOT EDIT
include::{root-partials}block-related-howto-p2psync-ws.adoc[]
include::{root-partials}_block-abstract.adoc[]
// DO NOT EDIT



:zero-config: {empty}

ifeval::["{param-platform}"=="{platform-ios}"]
:zero-config: such as Bonjour -- see: https://developer.apple.com/bonjour/
endif::[]
ifeval::["{param-platform}"=="{platform-android}"]
:zero-config: such as Network Service Discovery -- see: https://developer.android.com/training/connect-devices-wirelessly/nsd
endif::[]



== Introduction
// tag::introduction[]
Couchbase Lite's peer-to-peer sync solution offers secure storage and bidirectional synchronization of data between edge devices without the need for a centralized cloud-based control point.

The solution provides n out-of-the-box implementation of a websocket based listener for use in peer-to-peer applications communicating over in IP-based networks.

This implementation enables customers to:

* Simplify application development by enabling sync with just a few lines of code
* Optimize network bandwidth usage and reduce data transfer cost with Delta Sync support
* Securely sync data with built-in support for TLS encryption and authentication support
* Significantly reduce complexity of managing document conflicts from concurrent writes with built-in conflict resolution support.
* Take advantage of built-in network resiliency
// end::introduction[]

== Overview
At its most basic, peer-to-peer replication requires one peer to act as the listener to the other peer's replicator.

image::ROOT:docs-listener-diagram.png[,600]

So, in order to use peer-to-peer replication in your application you must configure one peer to act as this listener using the provided listener API endpoints, the most important of which include _URLEndpointListener_ and _URLEndpointListenerConfiguration_.
Using these building blocks, developers can quickly implement peer-to-peer replication.

.Simple workflow
====
. Configure the listener (_passive peer_, or _server_)
. Initialize the listener, which listens for incoming websocket connections (on a user-defined, or auto-selected, port)
. Configure a replicator (_active peer, or _client_)
. Use some form of discovery phase perhaps with a zero-config protocol {zero-config}, or use known URL endpoints, to identify a listener
. Point the replicator at the listener
. Initialize the replicator +
. Replicator and listener engage in the configured security protocol exchanges to confirm connection
. If connection is confirmed then replication will commence, synchronizing the two data stores.

====

As you can see this involves configuring a {xref-cbl-pg-dbo-p2psync-websocket-using-passive} and an
*** {xref-cbl-pg-dbo-p2psync-websocket-using-active}; you can find the instructions to do that on those two links and see a simple listener configuration in <<simple-configuration>>

You can also learn more about how to implement peer-to-peer replication by referring to our tutorial -- see: {xref-cbl-pg-tutorial-p2psync}.

// include::{snippet-p2psync-ws}[tags="listener-initialize!listener-config-db;!listener-config-netw-iface;!listener-config-tls-id-full", indent=0]

== Listener Features

* Each listener instance serves one Couchbase Lite database
* There is no hard limit on the number of listener instances associated with a database
* Listeners will automatically select a port to use or will use a user-specified port
* Listeners support encryption and authentication over TLS with multiple modes comprising:
** CA Cert
** Self-signed Cert
** Anonymous Self-signed -- Auto-generated anonymous TLS Identity if none specified; provides encryption but *not* authentication
** Not-enabled, that-is, clear text.
* Support for basic authentication.
* Delta Sync Support.

// include::{snippet-p2psync-ws}[tags=listener-initialize, indent=0]
[#simple-configuration]
.Simple configuration
=====
[tabs]
====

Simple Listener::
+
--

This simple configuration will give you a listener ready to participate in an encrypted synchronization with a replicator providing a valid user name and password.

[source, {source-language}]
----

include::{snippet-p2psync-ws}[tags=listener-simple, indent=0]

----

<.> Initialize the listener configuration
<.> Configure the client authenticator to require basic authentication
<.> Initialize the listener
<.> Start the listener

--

Simple Replicator::
+
--
This simple replicator configuration will give you an encrypted, bi-directional peer-to-peer synchronization with automatic conflict resolution.

[source, {source-language}]
----

include::{snippet-p2psync-ws}[tags=replicator-simple, indent=0]

----

<.> Get the listener's endpoint. Here we use a known URL, but it could be established dynamically in a discovery phase.
<.> Initialize the replicator configuration with the database to be synchronized and the listener it is to synchronize with
<.> Configure the replicator to expect a self-signed certificate from the listener
<.> Configure the replicator to present basic authentication credentials if the listener prompts for them (client authentication is optional)
<.> Initialize the replicator
<.> Start the replicator

--

====

=====

== API Highlights

include::{root-partials}p2p-api.adoc[leveloffset=+1]

== Security

=== Authentication
// include::{root-partials}p2p-security.adoc[leveloffset=+1]

Peer-to--peer sync supports <<using-basic-authentication, Basic Authentication>> and <<using-tls,TLS Authentication>>.
For anything other than test deployments, we strongly encourage the use of TLS. In fact, peer-to-peer sync using URLEndpointListener is encrypted using TLS by default.

The authentication mechanism used is defined at endpoint level, meaning that it is independent of the database being replicated.
So when replicating multiple database instances you may use basic on one instance an another authentication method on other instances.

NOTE: The Minimum supported version of TLS is TLS 1.2.

Peer-to-peer sync using URLEndpointListener supports certificate based authentication of the server and-or listener:

* Replicator certificates can be: self signed, from trusted CA or anonymous (system generated).
* Listeners certificates may be: self signed or trusted CA signed.
+
Where a TLS certificate is not explicitly specified for the listener, the Listener implementation will generate anonymous certificate to use for encryption

* The URLEndpointListener supports the ability to opt out of TLS encryption communication.
+
Active clients replicating with a URLEndpointListener have the option to skip validation of server certificates when the listener is configured with self-signed certificates.
+
This option is ignored when dealing with CA certificates.

[#using-secure-storage]
=== Using Secure Storage
The use of TLS, its associated keys and certificates requires using secure storage to minimize the chances of a security breach.
The implementation of this storage differs from platform to platform.
<<secure-storage-details>> summarizes the secure storage used to store keys and certificates for {param-title}.

.Secure storage details
[#secure-storage-details,cols="1,4"]
|===
include::{root-partials}secure-storage.adoc[tag={param-platform}]
|===

// == Sizing

// // include::{root-partials}p2p-sizing.adoc[leveloffset=+1]

// * Sizing - eg num websocket endponi listeners
// ** The scalability of the sync must only be limited by OS-level factors like number of open socket descriptions, volume of mutations getting synced .
// * We must provide some guidance on the sizing factors that will determine the number of supported clients. This is probably the most commonly asked question when it comes to p2p support. Alternatives like MPC specify the same.
// // Context: This has been one of the reasons why off-the-shelf solutions havenâ€™t worked requiring custom implementation

// DO NOT EDIT OR REMOVE
include::{root-partials}block-related-content-p2psync.adoc[]
// DO NOT EDIT OR REMOVE