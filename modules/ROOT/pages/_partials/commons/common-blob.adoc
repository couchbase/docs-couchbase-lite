// Inclusion for use in {src-lang}-ref-api.adoc files
// Blobs
// = Working with Blobs
// :page-partial:
// :page-layout: article
// :page-status:
// :page-edition:
// :page-role:
// :description: Couchbase mobile database blobs - concepts

// include::partial$_std-cbl-hdr-{param-module}.adoc[]

== Introduction

Couchbase Lite for {param-title} uses _blobs_ to store the contents of images, other media files and similar format files as binary objects.

The blob itself is not stored in the document.
It is held in a separate content-addressable store indexed from the document and retrieved only on-demand.

When a document is synchronized, the Couchbase Lite replicator adds an `_attachments` dictionary to the document's properties if it contains a blob -- see <<img-blob>>.


== Blob Objects


The blob as an object appears in a document as dictionary property -- see, for example _avatar_ in <<ex-blobobj>> and <<img-blob>>.

Alternatively, you can save the blob to a database without associating it with any documents.
A use case for this might be to allow a third-party plugin to save the Blob and set the Blob as JSON dictionary into a JSON document.
*Note* blobs not associated with a documents are removed when compacting the database.

A random access name is generated for each blob and stored in a SHA-1 encrypted property (`digest`).
Other properties include `length` (the length in bytes), and optionally `content_type` (typically, its MIME type).

On Couchbase Lite, blobs can be arbitrarily large.
They are only read on demand, not when you load a the _document_.

On Sync Gateway, the maximum content size is 20 MB per blob.
If a document's blob is over 20 MB, the document will be replicated but not the blob.

The blob API lets you access the contents as in-memory data (a `Data` object) or as an `InputStream`.


[#ex-blobobj]
.JSON Blob Object
====
[source, JSON]
----
"blob-id": { // <.>
    "type": "blob",
    "content_type" : "image/jpg", // <.>
    "length" : 38,
    "digest": "sha1-QneWo5IYIQ0ZrbCG0hXPGC6jy7E=" // <.>
}
----

<.> This is the identity of the blob assigned by us; note that replication auto-generates a blob for attachments and assigns its own name to it (for example, `blob_1`) -- see <<img-blob>>
<.> The content type is typically assigned the Mime type value for the blob content, for for example `.svg` content would be `imag/svg+xml`
<.> The digest is generated by the save action and uniquely identifies the blob content's location.

====


== JSON Blob Objects

You can also access a blob object as a JSON dictionary -- see <<ex-usingblobs>>.
To support this the API provides a couple of additional methods:

* <<isBlob()>> -- Returns true if the given properties represent Blob, otherwise returns false.
*Note* the dictionary should not contain any other keys beside @type, content_type, length, and digest.
* <<ToJSON>> -- Returns a dictionary representation of the blob object in JSON string format. The dictionary contain only metadata information.
+
--
*Note* that the blob's `digest` data is generated by the `save` operation, so calling <<toJSON()>> on an unsaved blob wil generate an IllegalStateException (`toJSON() is not allowed as Blob has not been saved in the database`).
--


== Using

Just instantiate a blob and set it as the value of a property.
Then later get the property value, which will be a blob object.

The following code example adds a blob to the document under the `blob1` property.

// :state: undefined
// ifdef::is-android[:state: Defined]

:tags: toJson-blob

[#ex-usingblobs]
.Using Blobs
====
In this example we:

* Create a blob
* Save it in a document
* Get the blob back as JSON
* Clone the original blob and check it is still recognized as a blob.

We use `image/jpg` as the blob MIME type and `avatar` as the key which references the blob within the document.
We use the key to retrieve the blob object later.

You will see that a random access name is generated for each blob, this is different to the `avatar` key and is used to locate the blob content -- see the blob structure in <<ex-blobobj>>

ifdef::is-android[]

[tabs]
=====
{source-language}::
+
--
endif::[]

[source, {source-language}]
----
include::{snippet}[tag="{tags}",indent=0]
----

ifdef::is-android[]
--
+
{source-language-alt}::
+
--
[source, {source-language-alt}]
----

include::{snippet-alt}[tag="{tags}",indent=0]

----

--

=====

endif::[]


<.> Here we prepare a document to use for the example
<.> Create the blob using the retrieved image
<.> Add the blob to a document
<.> You can save just the blob to the database for later retrieval if it suits your use case.
It does not need to be a part of a document.
<.> Retrieve a blob from a saved document as a JSON string
<.> Check the reconstituted blob is 'still' a blob.

====

If we use the Couchbase Server Admin Console to examine the position after a Sync Gateway replication we will see that the saved and sync'd document now contains an `_attachments` dictionary `blob_1` -- see: <<img-blob>>

You could retrieved the blob using the Sync Gateway REST API at http://localhost:4984/justdoit/user.david/blob_1.
*Note* that the blob identifier in the URL path is `blob_1` (not `avatar`).

[#img-blob]
.Sample document blob format
image::ROOT:attach-replicated.png[]


