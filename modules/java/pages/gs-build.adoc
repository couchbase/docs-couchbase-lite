:docname: gs-build
:page-module: java
:page-relative-src-path: gs-build.adoc
:page-origin-url: https://github.com/couchbase/docs-couchbase-lite.git
:page-origin-start-path:
:page-origin-refname: antora-assembler-simplification
:page-origin-reftype: branch
:page-origin-refhash: (worktree)
[#java:gs-build:::]
=== Build and Run
:page-aliases: start/java-gs-build.adoc
:page-role:
:description: Build and run a starter app to validate your install of Couchbase Lite on Java
:keywords: mobile edge nosql api Java JVM web-app device-app






// BEGIN -- _define_module_attributes.adoc -- Java
//
// Definition:
//    Objective: This adoc defines values for attributes specific to pages within this module (Java)
//    Invoked-by: ROOT:_partials/_std_cbl_hdr.adoc (from within module/_partials/_set_page_context_for_java.adoc)
//    Parameters: none
// End Definition:


// BEGIN -- module page attributes
// Begin workaround for 2.8.1 mis-release, to avoid unnecessary install of 2.8.0
// SET full maintenance version number

// VECTOR SEARCH attributes

// End workaround
// :snippet-p2psync-ws: {snippets-p2psync-ws--java}
// END -- module page attributes


// BEGIN -- Define API References for this module
//  These attributes s
//:url-api-references-structs: https://docs.couchbase.com/mobile/{major}.{minor}.{maintenance-java}{empty}/couchbase-lite-java/Structs
// :url-api-references-classes: https://docs.couchbase.com/mobile/{major}.{minor}.{maintenance-java}{empty}/couchbase-lite-java/Classes




// Supporting Data Type Classes



// DatabaseConfiguration


//Database.SAVE



//Database.DELETE()




// deprecated 2.8
//
// :url-api-method-database-compact: https://docs.couchbase.com/mobile/{major}.{minor}.{maintenance-java}{empty}/couchbase-lite-java/com/couchbase/lite/Database.html#compact--[Database.compact()]
// was copy-java.io.File-java.lang.String-com.couchbase.lite.DatabaseConfiguration-[Database.copy()]





// links for documents pages


// :url-api-class-dictionary: https://docs.couchbase.com/mobile/{major}.{minor}.{maintenance-java}{empty}/couchbase-lite-java/com/couchbase/lite/Dictionary.html[property accessors]

// QUERY RELATED CLASSES and METHODS

// Result Classes and Methods




// Query class and methods

// Expression class and methods


// ArrayFunction class and methods
// https://docs.couchbase.com/mobile/2.8.0/couchbase-lite-java/com/couchbase/lite/ArrayFunction.html


// Function class and methods
//

// Where class and methods
//

// orderby class and methods
//

// GroupBy class and methods
//

// Endpoints








// https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-java/com/couchbase/lite/URLEndpointListenerConfiguration.html#setPort-int-







// diag: Env+Module java




// Authenticators




// Replicator API










//:url-api-property-replicator-status-activity: https://docs.couchbase.com/mobile/{major}.{minor}.{maintenance-java}{empty}/couchbase-lite-java/com/couchbase/lite/Replicator.html#s:18CouchbaseLiteandroid10ReplicatorC13ActivityLevelO


// ReplicatorStatus



// ReplicatorConfiguration API












// replaced
// replaced
// replaces ^^



// Begin Replicator Retry Config
// End Replicator Retry Config










// Meta API


// END -- Define API References for this module

// diag: Env+Module java



// BEGIN Logs and logging references
// :url-api-class-logging: https://docs.couchbase.com/mobile/{major}.{minor}.{maintenance-java}{empty}/couchbase-lite-java/Logging.html[Logging classes]






// END  Logs and logging references







// END -- _define_module_attributes.adoc -- Java

// BEGIN::module page attributes
// :snippet-p2psync-ws: {snippets-p2psync-ws--java}

// END::Local page attributes

// :JP: Java
:tabs:


// DO NOT EDIT
[abstract]
--
Description -- _{description}_ +
_Abstract -- This content provides sample code and instructions that enable you to test your Couchbase Lite for java installation._ +
Related Content -- xref:java:gs-install.adoc[Install] | xref:java:gs-prereqs.adoc[Prerequisites] | xref:java:gs-build.adoc[Build and Run] |
--
// include::ROOT:partial$block-related-get-started.adoc[]
// DO NOT EDIT


[discrete#java:gs-build:::build-a-getting-started-app]
==== Build a Getting Started App

This section explains how to validate your configured build environment by building a starter app that uses many of pass:q,a[pass:q,a[_pass:q,a[pass:q,a[Couchbase{nbsp}Lite]]_]] on Java's more common features.

// TIP: The GettingStarted app can be downloaded from GitHub link:https://github.com/ibsoln/cblGettingStarted.git[GettingStarted].

The GettingStarted app demonstrates how to use pass:q,a[pass:q,a[_pass:q,a[pass:q,a[Couchbase{nbsp}Lite]]_]] on Java. Console and Web App versions are available.

.Development-type Scenarios
[{tabs}]
====

Desktop App::
+
--

TIP: Ensure you added the pass:q,a[Couchbase{nbsp}Lite] dependency to your `build.gradle` file

Create, build and run a new project using the following `GettingStarted.java` code:


[source,java]
----

    // <.>
    // One-off initialization
    CouchbaseLite.init();
    System.out.println("CBL Initialized");

    // <.>
    // Create a database
    Database database = new Database("mydb");
    System.out.println("Database created: mydb");

    // <.>
    // Create a new collection (like a SQL table) in the database.
    Collection collection = database.createCollection("myCollection", "myScope");
    System.out.println("Collection created: " + collection);

    // <.>
    // Create a new document (i.e. a record)
    // and save it in a collection in the database.
    MutableDocument mutableDoc = new MutableDocument()
        .setString("version", "2.0")
        .setString("language", "Java");
    collection.save(mutableDoc);

    // <.>
    // Retrieve immutable document and log the database generated
    // document ID and some document properties
    Document document = collection.getDocument(mutableDoc.getId());
    if (document == null) {
        System.out.println("No such document :: " + mutableDoc.getId());
    }
    else {
        System.out.println("Document ID :: " + document.getId());
        System.out.println("Learning :: " + document.getString("language"));
    }

    // <.>
    // Retrieve and update a document.
    document = collection.getDocument(mutableDoc.getId());
    if (document != null) {
        collection.save(document.toMutable().setString("language", "Kotlin"));
    }

    // <.>
    // Create a query to fetch documents with language == "Kotlin"
    Query query = QueryBuilder.select(SelectResult.all())
        .from(DataSource.collection(collection))
        .where(Expression.property("language")
            .equalTo(Expression.string("Kotlin")));

    try (ResultSet rs = query.execute()) {
        System.out.println("Number of rows :: " + rs.allResults().size());
    }

    //  <.>
    // OPTIONAL -- if you have Sync Gateway Installed you can try replication too
    // Create a replicator to push and pull changes to and from the cloud.
    // Be sure to hold a reference somewhere to prevent the Replicator from being GCed
    // BasicAuthenticator basAuth = new BasicAuthenticator("sync-gateway", "password".toCharArray());
    CollectionConfiguration collConfig = new CollectionConfiguration()
        .setPullFilter((doc, flags) -> "Java".equals(doc.getString("language")));

    ReplicatorConfiguration replConfig = new ReplicatorConfiguration(
        new URLEndpoint(new URI("ws://localhost:4984/getting-started-db")))
        .addCollection(collection, collConfig)
        .setType(ReplicatorType.PUSH_AND_PULL)
        .setAuthenticator(new BasicAuthenticator("sync-gateway", "password".toCharArray()));

    Replicator replicator = new Replicator(replConfig);

    // Listen to replicator change events.
    // Use `token.remove()` to stop the listener
    ListenerToken token = replicator.addChangeListener(change -> {
        System.out.println("Replicator state :: " + change.getStatus().getActivityLevel());
    });

    // Start replication.
    replicator.start();
}
----

<.> Initialize the library
<.> Create a database
<.> Create a collection
<.> Create a new document
<.> Retrieve document and log its ID
<.> Retrieve the document as mutable and change the `language` to `Kotlin` and save it
<.> Query the database output count and id to log
<.> Optionally, initiate a replication

On running the app, you should see the document ID and property printed to the console together with a query result showing the number of rows in the database.

This shows the document was successfully persisted to the database.

See <<About the Getting Started App>> for more on the app itself

--

Web App::
+
--

This section explains how to set-up a build project to create pass:q,a[pass:q,a[_pass:q,a[pass:q,a[Couchbase{nbsp}Lite]]_]] on Java web apps using gradle and Intellij IDEA.

*Steps*

. Create a new project folder and add a `build.gradle` file similar to this one.
+
[source,groovy,subs=attributes+]
----
include::example$GetStartedWS/build.gradle.sample
----

. Within Intellij IDEA, open the new project folder
+
If you don't have auto-import enabled, then accept the *Import from Gradle* prompt that appears at the bottom right of the screen.
. Create a Java class _DBManager_ using this code:
+
[source, java]

----

    // <.>
    // One-off initialization
    private void init() {
        CouchbaseLite.init();
    }

    // <.>
    // Create a database
    public Database createDb(String dbName) throws CouchbaseLiteException {
        return new Database(dbName);
    }

    // <.>
    // Create a new named collection (like a SQL table)
    // in the database's default scope.
    public Collection createCollection(Database database, String collName) throws CouchbaseLiteException {
        return database.createCollection(collName);
    }

    // <.>
    // Create a new document (i.e. a record)
    // and save it in a collection in the database.
    public String createDoc(Collection collection) throws CouchbaseLiteException {
        MutableDocument mutableDocument = new MutableDocument()
            .setFloat("version", 2.0f)
            .setString("language", "Java");
        collection.save(mutableDocument);
        return mutableDocument.getId();
    }

    // <.>
    // Retrieve immutable document and log the database generated
    // document ID and some document properties
    public Document retrieveDoc(Collection collection, String docId) throws CouchbaseLiteException {
        return collection.getDocument(docId);
    }

    // <.>
    // Retrieve and update a document.
    public void updateDoc(Collection collection, String docId) throws CouchbaseLiteException {
        Document document = collection.getDocument(docId);
        if (document != null) {
            collection.save(
                document.toMutable().setString("language", "Kotlin"));
        }
    }

    // <.>
    // Create a query to fetch documents with language == Kotlin.
    public List<Map<String, Object>> queryDocs(Collection collection) throws CouchbaseLiteException {
        Query query = QueryBuilder.select(SelectResult.all())
            .from(DataSource.collection(collection))
            .where(Expression.property("language").equalTo(Expression.string("Kotlin")));
        List<Map<String, Object>> results = new ArrayList<>();
        try (ResultSet rs = query.execute()) {
            for (Result result: rs) { results.add(result.toMap()); }
        }
        return results;
    }

    // <.>
    // OPTIONAL -- if you have Sync Gateway Installed you can try replication too.
    // Create a replicator to push and pull changes to and from the cloud.
    // Be sure to hold a reference somewhere to prevent the Replicator from being GCed
    public Replication startReplicator(Collection collection, ReplicatorChangeListener listener)
        throws URISyntaxException {
        CollectionConfiguration collConfig = new CollectionConfiguration()
            .setPullFilter((doc, flags) -> "Java".equals(doc.getString("language")));

        ReplicatorConfiguration replConfig =
            new ReplicatorConfiguration(
                new URLEndpoint(new URI("ws://localhost:4984/getting-started-db")))
                .addCollection(collection, collConfig)
                .setType(ReplicatorType.PUSH_AND_PULL)
                .setAuthenticator(new BasicAuthenticator("sync-gateway", "password".toCharArray()));

        Replicator replicator = new Replicator(replConfig);

        // Listen to replicator change events.
        // Use `token.remove()` to stop the listener
        ListenerToken token = replicator.addChangeListener(listener);

        // Start replication.
        replicator.start();

        return new Replication(replicator, token);
    }


    public void stopReplicator(Replication replication) {
        if (replication == null) { return; }
        replication.token.remove();
        replication.replicator.stop();
    }
}

----

. Create a Servlet similar to the one found in the example GettingStartedServlet
+
. Create an `index.html` file in `src/main/web app` with the following content:
+
[source, html]

----
include::example$GetStartedWS/src/main/webapp/index.html
----

. Create a `showDbItems.jsp` file in `src/main/web app` with the following content:
+
[source, html]

----
include::example$GetStartedWS/src/main/webapp/showDbItems.jsp
----

. Build, deploy and run the app using `jettyRun`
+
// !!!GBM: THIS IMAGE PROBABLY NEEDS UPDATING
image::couchbase-lite/current/java/_images/GradleMenuWebApp.png[,300]

.. Point your browser to: `localhost:8080/'
+
This opens the browser at your index.html page.
..  Select the *here* link
+
This launches the servlet and displays the results in `showdDbItems.jsp`.

--


// !!!GBM: I DON"T THINK THIS SHOULD BE A TAB
// It seems like it ought to be just text under the tabbed section.

+
About the Starter App::
+
--

anchor:bmkAboutGettingStarted[]
The GettingStarted app will:

* Create a database
+
The app creates its database in the `/getting-started.cblite2` directory relative to its root location when run (See: <<java:database:::lbl-find-db-loc,Finding a Database File>>).

TIP: Explicitly state your required database location when creating your database (see: <<java:database:::lbl-find-db-loc,Finding a Database File>> for how to do this)

* Add content to the DB
* Run a simple query counting the DB rows
* Start a one-shot, bi-directional replication using pass:q,a[pass:q,a[_pass:q,a[Sync{nbsp}Gateway]_]] and pass:q,a[_Couchbase{nbsp}Server_]
* Produce a simple report on the db Contents
+
// !!!GBM: THIS IMAGE PROBABLY NEEDS UPDATING
image::couchbase-lite/current/java/_images/cblOutput.png[,400]

NOTE: Before starting your app ensure you have started both your pass:q,a[_Couchbase{nbsp}Server_] and pass:q,a[pass:q,a[_pass:q,a[Sync{nbsp}Gateway]_]] instances.

--

====


